# Настройка Telegram бота для HomeAccountingLegendary

## 1. Создание бота в Telegram

1. Найдите @BotFather в Telegram
2. Отправьте команду `/newbot`
3. Введите имя бота (например: "Мой Финансовый Помощник")
4. Введите username бота (например: "my_finance_bot")
5. Сохраните полученный токен

## 2. Настройка переменных окружения

Создайте файл `.env` в корне проекта (используйте `env.example` как шаблон):

```env
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_WEBHOOK_URL=https://yourdomain.com
TELEGRAM_WEBHOOK_SECRET=a7f9e2b8c4d1e6f3g9h2i5j8k1l4m7n0o3p6q9r2s5t8u1v4w7x0y3z6
BOT_USERNAME=your_bot_username

# Django Settings
DJANGO_SETTINGS_MODULE=core.settings.dev
```

**Важно:** Проект использует `python-dotenv` для автоматической загрузки переменных окружения из `.env` файла. Это обеспечивает:
- Безопасное хранение секретных данных
- Легкое переключение между средами разработки и продакшена
- Соответствие принципам 12-factor app

## 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

**Новые зависимости для Telegram бота:**
- `aiogram==3.4.1` - современная библиотека для Telegram ботов
- `aiohttp==3.9.5` - асинхронные HTTP запросы
- `cryptg==0.4.0` - быстрое шифрование
- `python-dotenv==1.0.1` - загрузка переменных окружения из .env файла

## 4. Запуск бота

### Для разработки (polling режим):
```bash
python manage.py run_bot
```

### Для продакшена (webhook режим):
```bash
python manage.py run_bot --webhook
```

## 5. Настройка webhook (для продакшена)

1. Убедитесь, что ваш сервер доступен по HTTPS
2. Установите переменную `TELEGRAM_WEBHOOK_URL`
3. Запустите бота в webhook режиме
4. Webhook будет автоматически установлен

## 6. Структура проекта

```
telegram_bot/
├── __init__.py
├── bot.py              # Основной файл бота
├── config.py           # Конфигурация
├── handlers.py         # Обработчики команд
├── keyboards.py        # Клавиатуры
├── middleware.py       # Middleware для аутентификации
├── utils.py           # Утилиты форматирования
├── views.py           # Django views для webhook
├── urls.py            # URL маршруты
└── management/
    └── commands/
        └── run_bot.py  # Команда запуска бота
```

## 7. Основные команды бота

- `/start` - Начать работу с ботом
- `/balance` - Показать баланс кошельков
- `/income` - Добавить доход
- `/expense` - Добавить расход
- `/wallets` - Управление кошельками
- `/categories` - Управление категориями
- `/help` - Помощь по командам

## 8. Особенности реализации

- **Аутентификация**: Пользователи автоматически создаются при первом обращении к боту
- **База данных**: Используется существующая Django ORM
- **Middleware**: Автоматическая работа с Django ORM в async контексте
- **FSM**: Состояния для пошагового ввода данных
- **Клавиатуры**: Интуитивный интерфейс с кнопками

## 9. Безопасность

- Все операции выполняются в транзакциях базы данных
- Валидация всех входящих данных
- Изоляция данных по пользователям
- Секретный токен для webhook

## 10. Расширение функционала

Для добавления новых команд:
1. Добавьте обработчик в `handlers.py`
2. Создайте клавиатуру в `keyboards.py` (если нужно)
3. Добавьте команду в `TELEGRAM_BOT_COMMANDS` в настройках
4. Обновите команду `/help`
