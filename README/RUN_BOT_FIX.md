# Исправление команды run_bot

## Проблема
Флаг `--kill-existing` не работал корректно - процессы находились, но не останавливались полностью.

## Исправления

### 1. Улучшена логика остановки процессов
- Добавлен агрессивный метод остановки `kill_processes_aggressive()`
- Увеличено время ожидания завершения процессов
- Добавлена финальная проверка успешности остановки

### 2. Улучшена диагностика
- Более подробные сообщения о процессе остановки
- Показ информации о процессах, которые не удалось остановить
- Проверка результата остановки в основном методе

### 3. Добавлены инструменты диагностики
- `diagnose_bot_processes.py` - скрипт для анализа активных процессов

## Как использовать

### Остановить все экземпляры и запустить бота:
```bash
python manage.py run_bot --kill-existing
```

### Диагностика процессов:
```bash
python diagnose_bot_processes.py
```

### Ручная остановка процессов:
```bash
python manage.py stop_bot --force
```

### Принудительный запуск (игнорировать конфликты):
```bash
python manage.py run_bot --force
```

## Что изменилось
- **Агрессивная остановка**: Сначала `terminate()`, затем `kill()` если процесс не завершился
- **Улучшенная диагностика**: Показ PID и командной строки проблемных процессов
- **Проверка результата**: Команда не запустится, если процессы не были остановлены
- **Больше времени ожидания**: 2 секунды вместо 1 для завершения процессов

## Устранение неполадок

### Если процессы все еще не останавливаются:
1. Запустите диагностику:
   ```bash
   python diagnose_bot_processes.py
   ```

2. Попробуйте остановить вручную:
   ```bash
   python manage.py stop_bot --force
   ```

3. Если не помогает, найдите PID процессов и завершите их вручную:
   ```bash
   # Windows
   taskkill /PID <номер_процесса> /F
   
   # Linux/Mac
   kill -9 <номер_процесса>
   ```

### Если команда все еще не работает:
- Проверьте права доступа к процессам
- Убедитесь, что процессы действительно связаны с ботом
- Попробуйте перезапустить терминал/IDE
