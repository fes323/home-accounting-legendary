# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

## üéØ –ü—Ä–æ–±–ª–µ–º–∞
–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram WebApp –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ. –û—Å—Ç–∞–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.

## üîç –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram Mini App –≤ production.env.template
**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ñ–∞–π–ª–µ `production.env.template` –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `TELEGRAM_MINIAPP_URL` –∏ `TELEGRAM_MINIAPP_DEBUG_MODE`.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —à–∞–±–ª–æ–Ω.

### 2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ iframe –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** `X_FRAME_OPTIONS = 'DENY'` –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ Telegram WebApp –≤ iframe.

**–†–µ—à–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ `X_FRAME_OPTIONS = 'SAMEORIGIN'` –∏ —Å–æ–∑–¥–∞–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π middleware.

### 3. CSRF –∑–∞—â–∏—Ç–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç Telegram –∑–∞–ø—Ä–æ—Å—ã
**–ü—Ä–æ–±–ª–µ–º–∞:** Django CSRF middleware –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram WebApp.

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ Telegram –∑–∞–ø—Ä–æ—Å–æ–≤.

## ‚úÖ –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –û–±–Ω–æ–≤–ª–µ–Ω `production.env.template`
```env
# URL Telegram Mini App (–ø–æ–ª–Ω—ã–π URL —Å –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º)
TELEGRAM_MINIAPP_URL=https://wallet.my-bucket.ru/telegram/mini-app/

# –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ Mini App –±–µ–∑ Telegram –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
TELEGRAM_MINIAPP_DEBUG_MODE=False
```

### 2. –°–æ–∑–¥–∞–Ω `telegram_bot/middleware_telegram.py`
- `TelegramWebAppMiddleware` - –æ—Ç–∫–ª—é—á–∞–µ—Ç CSRF –¥–ª—è Telegram –∑–∞–ø—Ä–æ—Å–æ–≤
- `TelegramWebAppSecurityMiddleware` - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è Telegram WebApp

### 3. –û–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Django
- –ò–∑–º–µ–Ω–µ–Ω `X_FRAME_OPTIONS` –Ω–∞ `SAMEORIGIN`
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞—Å—Ç–æ–º–Ω—ã–µ middleware –≤ `MIDDLEWARE`

### 4. –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `update_production_auth.py`
–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
```bash
# –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/wallet.my-bucket.ru/home-accounting-legendary

# –ü–æ–ª—É—á–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git pull origin main

# –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source venv/bin/activate
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
python update_production_auth.py
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
# –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
cp .env .env.backup

# –û–±–Ω–æ–≤–∏—Ç–µ .env –∏–∑ —à–∞–±–ª–æ–Ω–∞
cp production.env.template .env

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
grep -E "TELEGRAM_MINIAPP_URL|TELEGRAM_MINIAPP_DEBUG_MODE" .env
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
sudo systemctl restart wallet-app

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Telegram –±–æ—Ç–∞
sudo systemctl restart wallet-bot

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
sudo systemctl status wallet-app
sudo systemctl status wallet-bot
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ Django –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
sudo journalctl -u wallet-app -f

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –±–æ—Ç–∞
sudo journalctl -u wallet-bot -f
```

### –®–∞–≥ 5: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
1. **–û—Ç–∫—Ä–æ–π—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É:**
   ```
   https://wallet.my-bucket.ru/telegram/mini-app/diagnostic/
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Mini App –∏–∑ Telegram –±–æ—Ç–∞:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram
   - –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üì± –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç

## üîß –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

#### 1. –í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
```bash
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª
nano .env

# –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞:
TELEGRAM_MINIAPP_DEBUG_MODE=True

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å
sudo systemctl restart wallet-app
```

#### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ –≤ BotFather
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Mini App URL –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: `https://wallet.my-bucket.ru/telegram/mini-app/`

#### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–æ–º–µ–Ω–∞
curl -I https://wallet.my-bucket.ru/telegram/mini-app/diagnostic/

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
openssl s_client -connect wallet.my-bucket.ru:443 -servername wallet.my-bucket.ru
```

#### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
```bash
# –ò—â–∏—Ç–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
sudo journalctl -u wallet-app | grep -i "telegram\|auth\|error"

# –ò—â–∏—Ç–µ –æ—à–∏–±–∫–∏ CSRF
sudo journalctl -u wallet-app | grep -i "csrf\|forbidden"
```

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

1. ‚úÖ **Telegram WebApp –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫** - –Ω–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ iframe
2. ‚úÖ **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
3. ‚úÖ **–ù–µ—Ç –æ—à–∏–±–æ–∫ CSRF** - middleware –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Telegram –∑–∞–ø—Ä–æ—Å—ã
4. ‚úÖ **–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
5. ‚úÖ **–õ–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** - –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞ –ø–æ—Å–ª–µ –≤—Å–µ—Ö —à–∞–≥–æ–≤:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É** - –æ–Ω–∞ –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Django** - –∏—â–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
3. **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–º–µ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ DNS –∏ SSL
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞** - URL Mini App –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º

## üîÑ –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é .env
cp .env.backup .env

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã
sudo systemctl restart wallet-app
sudo systemctl restart wallet-bot
```
